<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ABC Pvt Ltd — GST Invoice Generator (E-invoice ready)</title>

<!-- SheetJS for Excel parsing (client side) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#0f1724;         /* dark navy */
    --card:#111827;       /* slate */
    --muted:#9aa7b2;      /* muted text */
    --accent:#c7a34b;     /* gold accent */
    --table-head:#083047; /* deep teal */
    --white:#ffffff;
  }
  body{
    margin:0;
    font-family:Inter,Segoe UI,Roboto,Arial;
    background:linear-gradient(180deg,var(--bg),#071024);
    color:var(--white);
    display:flex;
    justify-content:center;
    padding:26px;
  }
  .app {
    width:100%;
    max-width:980px;
    background:linear-gradient(180deg,var(--card),#0b1220);
    border-radius:12px;
    padding:20px;
    box-shadow:0 12px 40px rgba(2,6,23,0.6);
  }
  header{display:flex;align-items:center;gap:16px;margin-bottom:16px}
  .logo{
    width:68px;height:68px;border-radius:8px;background:linear-gradient(120deg,var(--accent),#8f6a2b);
    display:flex;align-items:center;justify-content:center;font-weight:700;color:#04121a;
  }
  h1{font-size:20px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  .controls{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px}
  .control-card{background:#071422;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  .control-card label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type=text],input[type=date],select{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#04121a;color:var(--white)}
  button.primary{background:linear-gradient(90deg,var(--accent),#b48a3a);border:none;padding:10px 12px;border-radius:8px;color:#04121a;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--white);cursor:pointer}

  .flex{display:flex;gap:12px;align-items:center}
  .items-section{margin-top:18px}
  table#items{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
  table#items th, table#items td{padding:8px;border:1px solid rgba(255,255,255,0.04)}
  table#items th{background:var(--table-head);color:var(--white);font-weight:600}
  tr:nth-child(even) td{background:rgba(255,255,255,0.01)}
  input.small{width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white)}

  .actions{display:flex;gap:10px;margin-top:12px;align-items:center}
  .summary-card{margin-top:18px;background:#071424;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  .summary-grid{display:grid;grid-template-columns:1fr 260px;gap:12px;align-items:start}
  .invoice-preview{margin-top:18px;background:#fff;color:#000;padding:12px;border-radius:8px}

  /* invoice table inside preview */
  .invoice-table{width:100%;border-collapse:collapse}
  .invoice-table th,.invoice-table td{border:1px solid #222;padding:6px;font-size:12px}
  .invoice-head{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:10px}
  .muted{color:#66788b;font-size:13px}
  .right{text-align:right}
  .download-link{color:var(--accent);cursor:pointer;text-decoration:underline}

  @media (max-width:880px){
    .controls{grid-template-columns:1fr}
    .summary-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <div class="logo">ABC</div>
      <div>
        <h1>ABC Pvt Ltd — GST Invoice Generator by Maharjan J</h1>
        <p class="lead">Professional color scheme · Excel import · E-Invoice JSON export · A5 printable</p>
      </div>
    </header>

    <!-- Top controls -->
    <div class="controls" id="topControls">
      <div class="control-card">
        <label>Company (pre-filled)</label>
        <div><strong>ABC Pvt Ltd</strong></div>
        <div class="muted">GSTIN: <code>33abcde124323</code></div>
      </div>

      <div class="control-card">
        <label>Invoice Date</label>
        <input type="date" id="invoiceDate">
        <label style="margin-top:8px">Invoice Number</label>
        <input type="text" id="invoiceNo" placeholder="G_Inv1_2025">
      </div>

      <div class="control-card">
        <label>Transaction Type</label>
        <select id="gstType">
          <option value="intra">Intra-state (CGST+SGST)</option>
          <option value="inter">Inter-state (IGST)</option>
        </select>

        <label style="margin-top:8px">Import Excel (items or single-invoice)</label>
        <input type="file" id="excelFile" accept=".xlsx,.xls,.csv">
        <div class="muted" style="font-size:12px;margin-top:6px">
          Excel should have columns: <code>InvoiceDate,CustomerName,CustomerGST,Description,HSN,Qty,Rate,GSTRate</code> — parser will populate invoice date (if present) and items.
        </div>
      </div>
    </div>

    <!-- Customer details -->
    <div style="display:flex;gap:12px;margin-top:14px;flex-wrap:wrap">
      <div style="flex:1" class="control-card">
        <label>Customer Name</label>
        <input type="text" id="customerName" placeholder="Buyer name">
        <label style="margin-top:8px">Customer GSTIN (optional)</label>
        <input type="text" id="customerGST" placeholder="22AAAAA0000A1Z5">
      </div>

      <div style="width:220px" class="control-card">
        <label>Logo (optional)</label>
        <input type="file" id="logoFile" accept="image/*">
        <div style="height:58px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px">
          Upload to appear on invoice
        </div>
      </div>
    </div>

    <!-- Items -->
    <div class="items-section">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Items</h3>
        <div class="flex">
          <button class="ghost" id="clearRows">Clear rows</button>
          <button class="primary" id="addRowBtn">+ Add Item</button>
        </div>
      </div>

      <table id="items" aria-label="Items table">
        <thead>
          <tr>
            <th style="width:32px">#</th>
            <th style="width:26%">Description</th>
            <th style="width:10%">HSN</th>
            <th style="width:8%">Qty</th>
            <th style="width:10%">Rate</th>
            <th style="width:10%">GST%</th>
            <th style="width:12%">Taxable</th>
            <th style="width:12%">GST Amt</th>
            <th style="width:12%">Invoice Val</th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
    </div>

    <div class="actions">
      <button class="primary" id="previewBtn">Preview Invoice</button>
      <button class="ghost" id="downloadHTML">Download Invoice (HTML)</button>
      <button class="ghost" id="downloadJSON">Download e-Invoice JSON</button>
      <div style="color:var(--muted);font-size:13px;margin-left:auto">Theme: <strong style="color:var(--accent)">Professional Navy</strong></div>
    </div>

    <div class="summary-card" id="summaryCard" style="display:none">
      <div class="summary-grid">
        <div>
          <div style="display:flex;justify-content:space-between;gap:12px">
            <div>
              <div class="muted">Taxable Value</div>
              <div style="font-size:18px;font-weight:700" id="sumTaxable">₹0.00</div>
            </div>
            <div>
              <div class="muted">Total GST</div>
              <div style="font-size:18px;font-weight:700" id="sumGST">₹0.00</div>
            </div>
            <div>
              <div class="muted">Invoice Value</div>
              <div style="font-size:18px;font-weight:700;color:var(--accent)" id="grandTotal">₹0.00</div>
            </div>
          </div>

          <div style="margin-top:10px;color:var(--muted);font-size:13px">
            <div id="gstBreakdown"></div>
          </div>
        </div>

        <div>
          <div style="margin-bottom:8px;color:var(--muted)">Summary preview</div>
          <div style="background:#071424;padding:10px;border-radius:8px;color:var(--muted);font-size:13px" id="summaryPreview">No preview yet</div>
          <div style="margin-top:8px;font-size:12px;color:var(--muted)">
            <strong>Note on e-invoice:</strong> This tool creates a JSON payload in e-invoice structure. <br><em>To get an IRN (signed e-invoice), you must submit this JSON to the GST IRP using your API credentials and digital signature (GSTN rules).</em>
          </div>
        </div>
      </div>
    </div>

    <!-- Invoice preview -->
    <div id="invoicePreviewContainer" style="margin-top:18px"></div>

  </div>

<script>
/* -------------------------
   Small built-in HSN map (extendable).
   When user types an exact match of a product key (case-insensitive) HSN & GST rate auto-fill.
------------------------- */
const productHSNMap = {
  "cement": {hsn:"2523", gst:28},
  "laptop": {hsn:"8471", gst:18},
  "mobile": {hsn:"8517", gst:18},
  "rice": {hsn:"1006", gst:0},
  "book": {hsn:"4901", gst:0},
  "soap": {hsn:"3401", gst:18},
  "fan": {hsn:"8414", gst:18},
  "television": {hsn:"8528", gst:28},
  "biscuit": {hsn:"1905", gst:18},
  "clothes": {hsn:"6201", gst:12},
  "shoes": {hsn:"6403", gst:5},
  "milk": {hsn:"0401", gst:0}
};

/* Utilities */
const currency = v => "₹" + Number(v||0).toFixed(2);
const el = id => document.getElementById(id);

/* Row management */
const itemsBody = el("itemsBody");
let rowIndex=0;

function addRow(data){
  rowIndex++;
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${rowIndex}</td>
    <td><input class="small desc" value="${data?.Description||''}" placeholder="Product description"></td>
    <td><input class="small hsn" value="${data?.HSN||''}"></td>
    <td><input class="small qty" type="number" min="0" value="${data?.Qty||1}"></td>
    <td><input class="small rate" type="number" min="0" value="${data?.Rate||0}"></td>
    <td>
      <select class="gst small">
        <option value="3">3%</option>
        <option value="5">5%</option>
        <option value="12">12%</option>
        <option value="18">18%</option>
        <option value="28">28%</option>
      </select>
    </td>
    <td class="taxable right">0.00</td>
    <td class="gstamt right">0.00</td>
    <td class="total right">0.00</td>
  `;
  // set GST select to data if present
  itemsBody.appendChild(tr);

  const desc = tr.querySelector(".desc");
  const hsn = tr.querySelector(".hsn");
  const gstsel = tr.querySelector(".gst");
  // preselect gst if provided in data
  if(data?.GSTRate) gstsel.value = data.GSTRate;

  // auto hsn when exact product key typed
  desc.addEventListener("input", ()=>{
    const key = desc.value.trim().toLowerCase();
    if(productHSNMap[key]){
      hsn.value = productHSNMap[key].hsn;
      gstsel.value = productHSNMap[key].gst;
    }
    computeRow(tr);
  });
  // recompute on inputs
  ["qty","rate","gst"].forEach(cls=>{
    tr.querySelector("."+cls).addEventListener("input", ()=>computeRow(tr));
  });

  // initial compute
  computeRow(tr);
}

/* Compute single row */
function computeRow(tr){
  const q = Number(tr.querySelector(".qty").value||0);
  const r = Number(tr.querySelector(".rate").value||0);
  const gst = Number(tr.querySelector(".gst").value||0);
  const base = q * r;
  const gstamt = base * gst / 100;
  const total = base + gstamt;
  tr.querySelector(".taxable").textContent = base.toFixed(2);
  tr.querySelector(".gstamt").textContent = gstamt.toFixed(2);
  tr.querySelector(".total").textContent = total.toFixed(2);
  computeSummary();
}

/* Compute summary */
function computeSummary(){
  const rows = Array.from(itemsBody.querySelectorAll("tr"));
  let taxable=0, totalGST=0, invoiceVal=0;
  // breakdown by rate for display (for CGST/SGST splits)
  const rateBreak = {};
  rows.forEach(tr=>{
    const base = Number(tr.querySelector(".taxable").textContent||0);
    const gstamt = Number(tr.querySelector(".gstamt").textContent||0);
    const rate = tr.querySelector(".gst").value;
    taxable += base; totalGST += gstamt; invoiceVal += (base+gstamt);
    rateBreak[rate] = (rateBreak[rate]||0) + gstamt;
  });

  el("sumTaxable").textContent = currency(taxable);
  el("sumGST").textContent = currency(totalGST);
  el("grandTotal").textContent = currency(invoiceVal);

  // show per-rate breakdown
  let brHTML = "";
  for(const r of Object.keys(rateBreak)){
    brHTML += `<div style="display:flex;justify-content:space-between"><div class="muted">GST @ ${r}%</div><div>${currency(rateBreak[r])}</div></div>`;
  }
  el("gstBreakdown").innerHTML = brHTML;

  // summary preview
  let summ = rows.map(tr=>{
    const desc = tr.querySelector(".desc").value || "(no desc)";
    const tot = Number(tr.querySelector(".total").textContent||0);
    return `${desc} — ${currency(tot)}`;
  }).join("<br>");
  el("summaryPreview").innerHTML = summ || "No items";
  el("summaryCard").style.display = rows.length ? "block":"none";
}

/* row add/clear events */
el("addRowBtn").addEventListener("click", ()=>addRow());
el("clearRows").addEventListener("click", ()=>{
  itemsBody.innerHTML=""; rowIndex=0; computeSummary();
});

/* Preview generation (tabular A5) */
el("previewBtn").addEventListener("click", ()=>{
  // basic validation
  const customer = el("customerName").value.trim() || "Customer";
  const custGST = el("customerGST").value.trim() || "";
  const invoiceNo = el("invoiceNo").value.trim() || generateInvoiceNumber();
  const invoiceDate = el("invoiceDate").value || new Date().toISOString().slice(0,10);
  const gstType = el("gstType").value;

  // assemble items
  const rows = Array.from(itemsBody.querySelectorAll("tr"));
  if(rows.length===0){ alert("Add at least one item before preview."); return; }

  let totalTaxable=0, totalGST=0, grand=0;
  let itemsHTML = "";
  const detailedItems = [];

  rows.forEach((tr, idx)=>{
    const desc = tr.querySelector(".desc").value || "";
    const hsn = tr.querySelector(".hsn").value || "";
    const qty = Number(tr.querySelector(".qty").value||0);
    const rate = Number(tr.querySelector(".rate").value||0);
    const gst = Number(tr.querySelector(".gst").value||0);
    const taxable = Number(tr.querySelector(".taxable").textContent||0);
    const gstamt = Number(tr.querySelector(".gstamt").textContent||0);
    const total = Number(tr.querySelector(".total").textContent||0);

    totalTaxable += taxable; totalGST += gstamt; grand += total;

    // build invoice table rows (tabular)
    itemsHTML += `<tr>
      <td style="text-align:center">${idx+1}</td>
      <td>${escapeHtml(desc)}</td>
      <td style="text-align:center">${escapeHtml(hsn)}</td>
      <td style="text-align:right">${qty}</td>
      <td style="text-align:right">${rate.toFixed(2)}</td>
      <td style="text-align:right">${gst}%</td>
      <td style="text-align:right">${taxable.toFixed(2)}</td>
      <td style="text-align:right">${gstamt.toFixed(2)}</td>
      <td style="text-align:right">${total.toFixed(2)}</td>
    </tr>`;

    detailedItems.push({
      SrNo: idx+1, PrdDesc: desc, HsnCd: hsn, Qty: qty, UnitPrice: rate, TaxableValue: taxable,
      GSTRate: gst, GSTAmount: gstamt, LineTotal: total
    });
  });

  // GST split
  let gstBreakupHTML = "";
  if(gstType==="intra"){
    gstBreakupHTML = `<tr><td colspan="7" style="text-align:right">CGST</td><td style="text-align:right">${(totalGST/2).toFixed(2)}</td><td></td></tr>
                      <tr><td colspan="7" style="text-align:right">SGST</td><td style="text-align:right">${(totalGST/2).toFixed(2)}</td><td></td></tr>`;
  } else {
    gstBreakupHTML = `<tr><td colspan="7" style="text-align:right">IGST</td><td style="text-align:right">${totalGST.toFixed(2)}</td><td></td></tr>`;
  }

  const logoTag = ""; // we can handle logo rendering if desired (omitted in preview for simplicity)

  const invoiceHTML = `
    <div class="invoice-preview" style="width:148mm;min-height:210mm;padding:10px">
      <div class="invoice-head">
        <div>
          <div style="font-size:18px;font-weight:700">ABC Pvt Ltd</div>
          <div class="muted">GSTIN: 33abcde124323</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:700">Tax Invoice</div>
          <div class="muted">Invoice No: ${escapeHtml(invoiceNo)}</div>
          <div class="muted">Date: ${escapeHtml(invoiceDate)}</div>
        </div>
      </div>

      <table class="invoice-table" style="width:100%;margin-bottom:10px">
        <tr><td colspan="6"><strong>Billed To</strong><br>${escapeHtml(customer)}${custGST?("<br>GSTIN: "+escapeHtml(custGST)):""}</td>
            <td colspan="3" style="text-align:right">Transaction: ${gstType==="intra"?"Intra-State":"Inter-State"}</td></tr>
      </table>

      <table class="invoice-table" style="width:100%;margin-bottom:8px">
        <thead>
          <tr>
            <th style="width:4%">#</th><th style="width:28%">Description</th><th style="width:8%">HSN</th>
            <th style="width:8%">Qty</th><th style="width:10%">Rate</th><th style="width:8%">GST%</th>
            <th style="width:10%">Taxable Value</th><th style="width:12%">GST Amt</th><th style="width:12%">Invoice Val</th>
          </tr>
        </thead>
        <tbody>
          ${itemsHTML}
          <tr><td colspan="7" style="text-align:right">Taxable Value</td><td style="text-align:right">${totalTaxable.toFixed(2)}</td><td style="text-align:right"></td></tr>
          ${gstBreakupHTML}
          <tr><td colspan="7" style="text-align:right"><strong>Invoice Value</strong></td><td style="text-align:right"><strong>${grand.toFixed(2)}</strong></td><td></td></tr>
        </tbody>
      </table>

      <div style="margin-top:10px;font-size:12px" class="muted">
        This invoice JSON can be downloaded and submitted to the government IRP (with proper authentication and digital signature) to obtain an IRN.
      </div>
    </div>
  `;

  el("invoicePreviewContainer").innerHTML = invoiceHTML;

  // build e-invoice JSON (approximate structure)
  currentEInvoice = {
    Version: "1.1",  /* sample */
    TranDtls: { /* transaction details */
      TaxSch: "GST",
      SupTyp: "B2B",
      RegRev: "N"
    },
    DocDtls: { /* invoice meta */
      Typ: "INV",
      No: invoiceNo,
      Dt: invoiceDate
    },
    SellerDtls: {
      Gstin: "33abcde124323",
      LglNm: "ABC Pvt Ltd"
    },
    BuyerDtls: {
      Gstin: custGST || "",
      LglNm: customer
    },
    ItemList: detailedItems,
    ValDtls: {
      AssVal: totalTaxable,
      CgstVal: gstType==="intra" ? (totalGST/2) : 0,
      SgstVal: gstType==="intra" ? (totalGST/2) : 0,
      IgstVal: gstType==="inter" ? totalGST : 0,
      TotInvVal: grand
    }
  };

  // show summary and enable downloads
  computeSummary();
  el("downloadJSON").disabled=false;
  el("downloadHTML").disabled=false;
});

/* CSV/Excel import handler - populates date/customer/items if columns exist */
el("excelFile").addEventListener("change", async (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const data = await f.arrayBuffer();
  const wb = XLSX.read(data, {type:"array"});
  // use first sheet
  const sheetName = wb.SheetNames[0];
  const sheet = wb.Sheets[sheetName];
  const json = XLSX.utils.sheet_to_json(sheet, {defval:""});
  if(json.length===0){ alert("Excel sheet empty"); return; }

  // if sheet includes InvoiceDate, set date from first row
  const first = json[0];
  if(first.InvoiceDate){
    // try parse yyyy-mm-dd or excel date
    let d = first.InvoiceDate;
    if(typeof d === "number"){ // excel date number
      const dt = XLSX.SSF.parse_date_code(d);
      const iso = `${dt.y}-${String(dt.m).padStart(2,"0")}-${String(dt.d).padStart(2,"0")}`;
      el("invoiceDate").value = iso;
    } else {
      // attempt to coerce
      el("invoiceDate").value = new Date(d).toISOString().slice(0,10);
    }
  }
  if(first.CustomerName) el("customerName").value = first.CustomerName;
  if(first.CustomerGST) el("customerGST").value = first.CustomerGST;

  // clear existing rows and add rows from excel
  itemsBody.innerHTML=""; rowIndex=0;
  json.forEach(r=>{
    // map expected columns (case-insensitive)
    const map = {};
    for(const key of Object.keys(r)){
      map[key.trim().toLowerCase()] = r[key];
    }
    const data = {
      Description: map["description"]||map["product"]||map["item"]||"",
      HSN: map["hsn"]||"",
      Qty: map["qty"]||map["quantity"]||1,
      Rate: map["rate"]||map["unitprice"]||map["price"]||0,
      GSTRate: map["gstrate"]||map["gst"]||map["tax"]||""
    };
    addRow(data);
  });

  computeSummary();
  alert("Excel imported: rows added. Please preview.");
});

/* Download e-invoice JSON */
let currentEInvoice = null;
el("downloadJSON").addEventListener("click", ()=>{
  if(!currentEInvoice){ alert("Generate a preview first."); return; }
  const blob = new Blob([JSON.stringify(currentEInvoice, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download = (currentEInvoice.DocDtls?.No||"einvoice") + ".json"; a.click();
  URL.revokeObjectURL(url);
});

/* Download invoice HTML */
el("downloadHTML").addEventListener("click", ()=>{
  const html = el("invoicePreviewContainer").innerHTML;
  if(!html){ alert("No preview. Generate preview first."); return; }
  const blob = new Blob([`<!doctype html><meta charset="utf-8"><title>Invoice</title><style>body{font-family:Arial;padding:10px;color:#000}</style>${html}`], {type:"text/html"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download = (el("invoiceNo").value || "invoice") + ".html"; a.click();
  URL.revokeObjectURL(url);
});

/* simple protect-escape for html injection in preview */
function escapeHtml(s){ return (s||"").toString().replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

/* invoice number generator (persist in localStorage) */
function generateInvoiceNumber(){
  const year = new Date().getFullYear();
  let last = Number(localStorage.getItem("lastInvoice")||0) + 1;
  localStorage.setItem("lastInvoice", last);
  return `G_Inv${last}_${year}`;
}
el("invoiceNo").addEventListener("focus", function(){ if(!this.value) this.value = generateInvoiceNumber(); });

/* logo optional: just preview store as dataURL - simple */
el("logoFile").addEventListener("change", (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  const fr = new FileReader();
  fr.onload = ()=> {
    // not used in this simple preview version, but could be inserted into the invoice HTML
    localStorage.setItem("companyLogo", fr.result);
    alert("Logo loaded — it will appear in downloaded HTML (preview currently omits inline image).");
  };
  fr.readAsDataURL(f);
});

/* init: add one empty row */
addRow();
computeSummary();
</script>
</body>
</html>
